<style>
.time-choose {
    display: flex;
    grid-gap: 8px;
    gap: 8px;
    align-items: center;
    width: 100%;
}

.time-choose__item {
    position: relative;
    border: 1px solid #e0e0e0;
    width: 100%;
    cursor: pointer;
    padding: 8px 16px;
    border-radius: 8px;
    background-color: #fff;
}

.active-time {
    border: none;
    background-color: #fff;
    padding: auto;
    width: 100%;
}

.active-time-dropdown {
    position: relative;
    width: 100%;
}

.selected-time {
    /* padding: 10px; */
    border: none;
    cursor: pointer;
    width: 100%;
    display: flex;
    justify-content: space-between;
}

.time-options {
    position: absolute;
    width: 100%;
    background-color: white;
    border: 1px solid #ccc;
    margin: 0;
    padding: 0;
    list-style-type: none;
    z-index: 10;
    height: 180px;
    overflow-y: auto;
}

.time-options li {
    padding: 10px;
    cursor: pointer;
}

.time-options li.disabled {
    color: gray;
    cursor: not-allowed;
}


.container_lich {
    position: relative;
    border: 1px solid #ccc;
    padding: auto;
    align-content: center;
    justify-content: center;
    justify-items: center;
    width: 700px;
    height: 80%;
    border-radius: 5px;
}

.container_lich .tren {
    padding: 20px;
}

.container_lich .tren button {
    padding: 7px 15px;

}

.container_lich .tren1 {
    padding: 10px;
}

ul {
    padding: 0 !important;
    margin: 0 !important;
    margin-left: 0 !important;
}
</style>
<template>
    <Message ref="message" />
    <div class="container_lich">
        <button @click="close">X</button>
        <label class="tren1">Thời gian</label>
        <ul>
            <li>
                <vue-cal class="lichvue" style="margin-bottom: 20px;height: 380px ;max-width: 650px;"
                    :default-view="'month'" :disable-views="['years', 'year', 'week', 'day']"
                    :selected-date="currentStartDate" :min-date="getFirstDayOfCurrentMonth()"
                    :disable-days="disabledDates" :months-to-show="1" @cell-click="onDateSelect"
                    @cell-mouseenter="onCellMouseEnter" :on-cell-render="customCellRenderer" />
            </li>
            <li>
                <div class="time-choose ">
                    <div class="time-choose__item">
                        <div>
                            <p class="title-time">Nhận xe</p>
                            <div class="active-time-dropdown" @click="toggleDropdown">
                                <div class="selected-time">
                                    <label for="">{{ selectedStartTime !== null ? availableHours[selectedStartTime].name
                                        :
                                        'Chọn giờ bắt đầu' }}</label>
                                    <img v-if="!dropdownOpen" width="24" height="24"
                                        src="https://img.icons8.com/ios/50/expand-arrow--v2.png"
                                        alt="expand-arrow--v2" />
                                    <img v-if="dropdownOpen" width="24" height="24"
                                        src="https://img.icons8.com/ios/50/collapse-arrow--v2.png"
                                        alt="collapse-arrow--v2" />
                                </div>
                                <!-- Danh sách các tùy chọn -->
                                <ul v-if="dropdownOpen != false" class="time-options">
                                    <li v-for="(hour, index) in availableHours" :key="index"
                                        @click.stop="selectTime(index)" :class="{ disabled: hour.disabled }"
                                        :disabled="hour.disabled" :hidden="startDate == null">
                                        {{ hour.name }} , {{ hour.disabled }}
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="time-choose__item">
                        <div>
                            <p class="title-time">Trả xe</p>
                            <div class="active-time-dropdown" @click="toggleDropdownV2">
                                <!-- Hiển thị giá trị đã chọn -->
                                <div class="selected-time">
                                    <label for="">{{ selectedEndTime !== null ? availableHours[selectedEndTime].name
                                        :
                                        'Chọn giờ kết thúc' }}</label>
                                    <img v-if="!dropdownOpenV2" width="24" height="24"
                                        src="https://img.icons8.com/ios/50/expand-arrow--v2.png"
                                        alt="expand-arrow--v2" />
                                    <img v-if="dropdownOpenV2" width="24" height="24"
                                        src="https://img.icons8.com/ios/50/collapse-arrow--v2.png"
                                        alt="collapse-arrow--v2" />
                                </div>
                                <!-- Danh sách các tùy chọn -->
                                <ul v-if="dropdownOpenV2" class="time-options">
                                    <li v-for="(hour, index) in availableHoursV2" :key="index"
                                        @click.stop="selectTimeV2(index)" :class="{ disabled: hour.disabled }"
                                        :disabled="hour.disabled" :hidden="startDate == null">
                                        {{ hour.name }} , {{ hour.disabled }}
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
            <!-- <label>Thời gian nhận và trả thuê xe: {{ selectedStartTime }} - {{ selectedEndTime }}</label> -->
            <div style="display: flex;justify-content: space-between;" class="tren">
                <label>Ngày thuê xe: {{ selectedStartTime }}:00, {{ startDate || 'Chưa chọn' }} - {{ selectedEndTime
                    }}:00, {{ endDate || 'Chưa chọn' }}</label>
                <button :disabled="selectedEndTime == null || endDate == null" @click="Submit()">Tiếp tục</button>
            </div>
        </ul>
    </div>
</template>
<script>
import VueCal from 'vue-cal';
import 'vue-cal/dist/vuecal.css';
import Message from '../../Message.vue';
import BookingService from '../../Service/api/BookingService';
export default {
    name: 'BookingCalendar',
    props: {
        id: {
            type: Number,
            default: 0,
            required: true
        },
    },
    components: {
        VueCal, Message
    },
    data() {
        return {
            dropdownOpen: false,
            dropdownOpenV2: false,
            show: false,
            message: "",
            booking: {
                // 2: {
                //     startLimit: "2024-10-30 13:00:00",
                //     endLimit: "2024-10-31 14:00:00",
                // },
                // 3: {
                //     startLimit: "2024-11-25 09:00:00",
                //     endLimit: "2024-11-26 5:00:00",
                // },
                // 4: {
                //     startLimit: "2024-11-26 13:00:00",
                //     endLimit: "2024-11-27 9:00:00",
                // },
                // 5: {
                //     startLimit: "2024-11-1 03:00:00",
                //     endLimit: "2024-11-2 09:00:00",
                // },
                // 6: {
                //     startLimit: "2024-11-15 13:00:00",
                //     endLimit: "2024-11-16 9:00:00",
                // },

            },
            availableHours: {
                0: { value: 0, name: "00:00", disabled: false },
                1: { value: 1, name: "01:00", disabled: false },
                2: { value: 2, name: "02:00", disabled: false },
                3: { value: 3, name: "03:00", disabled: false },
                4: { value: 4, name: "04:00", disabled: false },
                5: { value: 5, name: "05:00", disabled: false },
                6: { value: 6, name: "06:00", disabled: false },
                7: { value: 7, name: "07:00", disabled: false },
                8: { value: 8, name: "08:00", disabled: false },
                9: { value: 9, name: "09:00", disabled: false },
                10: { value: 10, name: "10:00", disabled: false },
                11: { value: 11, name: "11:00", disabled: false },
                12: { value: 12, name: "12:00", disabled: false },
                13: { value: 13, name: "13:00", disabled: false },
                14: { value: 14, name: "14:00", disabled: false },
                15: { value: 15, name: "15:00", disabled: false },
                16: { value: 16, name: "16:00", disabled: false },
                17: { value: 17, name: "17:00", disabled: false },
                18: { value: 18, name: "18:00", disabled: false },
                19: { value: 19, name: "19:00", disabled: false },
                20: { value: 20, name: "20:00", disabled: false },
                21: { value: 21, name: "21:00", disabled: false },
                22: { value: 22, name: "22:00", disabled: false },
                23: { value: 23, name: "23:00", disabled: false },
            },
            availableHoursV2: {
                0: { value: 0, name: "00:00", disabled: false },
                1: { value: 1, name: "01:00", disabled: false },
                2: { value: 2, name: "02:00", disabled: false },
                3: { value: 3, name: "03:00", disabled: false },
                4: { value: 4, name: "04:00", disabled: false },
                5: { value: 5, name: "05:00", disabled: false },
                6: { value: 6, name: "06:00", disabled: false },
                7: { value: 7, name: "07:00", disabled: false },
                8: { value: 8, name: "08:00", disabled: false },
                9: { value: 9, name: "09:00", disabled: false },
                10: { value: 10, name: "10:00", disabled: false },
                11: { value: 11, name: "11:00", disabled: false },
                12: { value: 12, name: "12:00", disabled: false },
                13: { value: 13, name: "13:00", disabled: false },
                14: { value: 14, name: "14:00", disabled: false },
                15: { value: 15, name: "15:00", disabled: false },
                16: { value: 16, name: "16:00", disabled: false },
                17: { value: 17, name: "17:00", disabled: false },
                18: { value: 18, name: "18:00", disabled: false },
                19: { value: 19, name: "19:00", disabled: false },
                20: { value: 20, name: "20:00", disabled: false },
                21: { value: 21, name: "21:00", disabled: false },
                22: { value: 22, name: "22:00", disabled: false },
                23: { value: 23, name: "23:00", disabled: false },
            },
            result: {
                key: 0,
                value: null
            },
            startDate: null,
            endDate: null,
            selectedStartTime: null,
            selectedEndTime: null,
            selectedDates: [],
            currentStartDate: new Date(),
            isFirstClick: true,
            hoveredDate: null, // Thêm biến để theo dõi ngày đang hover
        };
    },
    computed: {

        disabledDates() {
            let disabled = [];
            // const disabled = [];
            const bookingDates = {}; // Object để đếm số lần xuất hiện của mỗi ngày
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Thêm các ngày đã qua

            // Đếm số lần xuất hiện của mỗi ngày trong các booking
            Object.values(this.booking).forEach(({ startLimit, endLimit }) => {
                let bookingStartDate = new Date(startLimit);
                let bookingEndDate = new Date(endLimit);

                // Format ngày để sử dụng làm key
                const startDateKey = bookingStartDate.format();
                const endDateKey = bookingEndDate.format();

                // Tăng số đếm cho ngày bắt đầu và kết thúc
                bookingDates[startDateKey] = (bookingDates[startDateKey] || 0) + 1;
                bookingDates[endDateKey] = (bookingDates[endDateKey] || 0) + 1;

                // Xử lý các ngày nằm giữa startLimit và endLimit
                if (bookingStartDate.getTime() !== bookingEndDate.getTime()) {
                    let currentDay = new Date(bookingStartDate);
                    currentDay.setDate(currentDay.getDate() + 1);

                    while (currentDay < bookingEndDate) {
                        const currentDayKey = currentDay.format();
                        disabled.push(currentDayKey);
                        currentDay.setDate(currentDay.getDate() + 1);
                    }
                }
            });

            // Xử lý logic khóa ngày dựa trên giờ và số lần xuất hiện
            Object.values(this.booking).forEach(({ startLimit, endLimit }) => {
                let bookingStartDate = new Date(startLimit);
                let bookingEndDate = new Date(endLimit);

                const startDateKey = bookingStartDate.format();
                const endDateKey = bookingEndDate.format();

                // Nếu ngày xuất hiện trong 2 booking trở lên, luôn khóa
                if (bookingDates[startDateKey] >= 2) {
                    if (!disabled.includes(startDateKey)) {
                        disabled.push(startDateKey);
                    }
                } else {
                    // Nếu chỉ xuất hiện 1 lần, áp dụng logic giờ cũ
                    const bookingStartHour = bookingStartDate.getHours();
                    if (bookingStartHour < 12) {
                        disabled.push(startDateKey);
                    }
                }

                if (bookingDates[endDateKey] >= 2) {
                    if (!disabled.includes(endDateKey)) {
                        disabled.push(endDateKey);
                    }
                } else {
                    const bookingEndHour = bookingEndDate.getHours();
                    if (bookingEndHour >= 12) {
                        disabled.push(endDateKey);
                    }
                    else {

                        disabled = disabled.filter(date => date !== endDateKey);
                    }
                }
            });
            let currentDate = new Date(today);
            currentDate.setDate(1);
            while (currentDate < today) {
                disabled.push(new Date(currentDate).format());
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Loại bỏ các ngày trùng lặp
            return [...new Set(disabled)];
        }

    },


    methods: {
        Submit() {
            console.log(this.selectedStartTime, this.selectedEndTime);
            const startday = this.formatDateTime(this.startDate, this.selectedStartTime);
            const endday = this.formatDateTime(this.endDate, this.selectedEndTime);
            this.$emit("GetDay", startday, endday);
        },
        async fecthHourByBooking() {
            try {
                const response = await PromotionService.getPromotion(id);
                if (response && response.data) {
                    this.promotion = response.data;
                } else {
                    console.warn("No promotion data received");
                }
            } catch (error) {
                console.error("Error fetching promotion:", error);
                throw error; // Re-throw để có thể bắt ở UserVoucher
            }
        },
        formatDateTime(date, time) {
            if (!date || !time) return null;
            if (time < 10) {
                return `${date}T0${time}:00`;
            }
            else {
                return `${date}T${time}:00`;
            }
        },
        toggleDropdown() {
            if (this.startDate != null) {
                this.dropdownOpen = !this.dropdownOpen;
            } 
            this.CheckHours();
        },
        selectTime(index) {
            // Kiểm tra nếu tùy chọn không bị khóa
            if (!this.availableHours[index].disabled) {
                this.selectedStartTime = index;
                this.dropdownOpen = false;
                console.log("Dropdown should now be closed:", this.dropdownOpen);
            }
        },
        toggleDropdownV2() {
            if (this.endDate != null) {
                this.dropdownOpenV2 = !this.dropdownOpenV2;
                console.log(this.dropdownOpenV2);
            } this.CheckHoursV2();
        },
        selectTimeV2(index) {
            // Kiểm tra nếu tùy chọn không bị khóa
            if (!this.availableHours[index].disabled) {
                this.selectedEndTime = index;
                console.log("Index: ", index);
                this.dropdownOpenV2 = false; // Đóng dropdown sau khi chọn
                // Gọi hàm CheckHours sau khi chọn giá trị
            }
        },

        getFirstDayOfCurrentMonth() {
            const today = new Date();
            // Tạo ngày đầu tiên của tháng hiện tại
            return new Date(today.getFullYear(), today.getMonth(), 1);
        },
        open(message) {
            this.$refs.message.ShowMess(message);
        },
        close() {
            //this.show = false;
            this.$emit('Close');
        },


        // CheckHours() {
        //     if (this.startDate == null) { this.open("Vui lòng chọn ngày bắt đầu!"); }
        //     if (this.startDate != null) {
        //         const formattedNow = new Date(this.startDate);
        //         const formattedNowDateString = formattedNow.toISOString().slice(0, 10);
        //         const todaynow = new Date();
        //         const today = todaynow.toISOString().slice(0, 10)
        //         // const hourtoday = todaynow.
        //         let isBooked = false; // Flag để kiểm tra ngày có nằm trong booking không

        //         // Đầu tiên reset tất cả các giờ về trạng thái false
        //         Object.values(this.availableHours).forEach(hour => {
        //             hour.disabled = false;
        //         });

        //         // Lặp qua các booking để kiểm tra
        //         Object.values(this.booking).forEach(e => {
        //             let bookingStartDate = new Date(e.startLimit);
        //             let bookingEndDate = new Date(e.endLimit);

        //             const bookingStartHour = bookingStartDate.getHours();
        //             const bookingEndHour = bookingEndDate.getHours();

        //             const bookingStartDateString = bookingStartDate.toISOString().slice(0, 10);
        //             const bookingEndDateString = bookingEndDate.toISOString().slice(0, 10);

        //             if (today === formattedNowDateString) {
        //                 // Nếu trùng ngày bắt đầu booking
        //                 console.log(todaynow.getHours());
        //                 isBooked = true;
        //                 this.resultHour('today', todaynow.getHours());
        //                 return;
        //             }
        //             if (bookingStartDateString === formattedNowDateString) {
        //                 // Nếu trùng ngày bắt đầu booking
        //                 isBooked = true;
        //                 this.resultHour('start', bookingStartHour);
        //                 return;
        //             }
        //             else if (bookingEndDateString === formattedNowDateString) {
        //                 // Nếu trùng ngày kết thúc booking
        //                 isBooked = true;
        //                 this.resultHour('end', bookingEndHour);
        //                 return;
        //             }
        //             else if (formattedNow > bookingStartDate && formattedNow < bookingEndDate) {
        //                 // Nếu nằm giữa khoảng booking
        //                 isBooked = true;
        //                 this.resultHour('middle', 0); // Khóa tất cả các giờ
        //                 return;
        //             }
        //         });

        //         if (!isBooked) {
        //             // Nếu là ngày trống, mở tất cả các giờ
        //             this.resultHour('free', 0);
        //         }
        //     }
        // },
        CheckHours() {
            if (this.startDate == null) { this.open("Vui lòng chọn ngày bắt đầu!"); }
            if (this.startDate != null) {
                const formattedNow = new Date(this.startDate);
                const formattedNowDateString = formattedNow.toISOString().slice(0, 10);
                const todaynow = new Date();
                const today = todaynow.toISOString().slice(0, 10)
                // const hourtoday = todaynow.
                let isBooked = false; // Flag để kiểm tra ngày có nằm trong booking không

                // Đầu tiên reset tất cả các giờ về trạng thái false
                Object.values(this.availableHours).forEach(hour => {
                    hour.disabled = false;
                });

                // Lặp qua các booking để kiểm tra
                Object.values(this.booking).forEach(e => {
                    let bookingStartDate = new Date(e.startLimit);
                    let bookingEndDate = new Date(e.endLimit);

                    const bookingStartHour = bookingStartDate.getHours();
                    const bookingEndHour = bookingEndDate.getHours();

                    const bookingStartDateString = bookingStartDate.toISOString().slice(0, 10);
                    const bookingEndDateString = bookingEndDate.toISOString().slice(0, 10);

                    if (today === formattedNowDateString) {
                        // Nếu trùng ngày bắt đầu booking
                        console.log(todaynow.getHours());
                        isBooked = true;
                        this.resultHour('today', todaynow.getHours());
                        return;
                    }
                    if (bookingStartDateString === formattedNowDateString) {
                        // Nếu trùng ngày bắt đầu booking
                        isBooked = true;
                        this.resultHour('start', bookingStartHour);
                        return;
                    }
                    else if (bookingEndDateString === formattedNowDateString) {
                        // Nếu trùng ngày kết thúc booking
                        isBooked = true;
                        this.resultHour('end', bookingEndHour);
                        return;
                    }
                    else if (formattedNow > bookingStartDate && formattedNow < bookingEndDate) {
                        // Nếu nằm giữa khoảng booking
                        isBooked = true;
                        this.resultHour('middle', 0); // Khóa tất cả các giờ
                        return;
                    }
                });

                if (!isBooked) {
                    // Nếu là ngày trống, mở tất cả các giờ
                    this.resultHour('free', 0);
                }
            }
        },

        CheckHoursV2() {
            if (this.endDate == null) {
                this.open("Vui lòng chọn ngày kết thúc!");
            }
            if (this.selectedStartTime == null) {
                this.open("Vui lòng chọn giờ ngày bắt đầu!");
            }
            if (this.endDate != null && this.selectedStartTime != null) {
                const formattedNow = new Date(this.endDate);
                const formattedStart = new Date(this.startDate);
                const formattedNowDateString = formattedNow.toISOString().slice(0, 10);
                const formattedStartDateString = formattedStart.toISOString().slice(0, 10);
                const todaynow = new Date();
                const today = todaynow.toISOString().slice(0, 10);
                let isBooked = false; // Flag để kiểm tra ngày có nằm trong booking không

                // Đầu tiên reset tất cả các giờ về trạng thái false
                Object.values(this.availableHours).forEach(hour => {
                    hour.disabled = false;
                });

                // Lặp qua các booking để kiểm tra
                Object.values(this.booking).forEach(e => {
                    let bookingStartDate = new Date(e.startLimit);
                    let bookingEndDate = new Date(e.endLimit);

                    const bookingStartHour = bookingStartDate.getHours();
                    const bookingEndHour = bookingEndDate.getHours();

                    const bookingStartDateString = bookingStartDate.toISOString().slice(0, 10);
                    const bookingEndDateString = bookingEndDate.toISOString().slice(0, 10);

                    // Nếu trùng ngày bắt đầu booking
                    if (today === formattedNowDateString && formattedStartDateString) {
                        console.log('1');
                        isBooked = true;
                        this.resultHourV2('today&start', todaynow.getHours(), this.selectedStartTime);
                        return;
                    }
                    // Nếu trùng ngày bắt đầu và ngày kết thúc booking

                    // Nếu trùng ngày bắt đầu booking và trùng với giờ bắt đầu
                    else if (bookingStartDateString === formattedNowDateString && formattedStartDateString) {
                        console.log('2');
                        isBooked = true;
                        this.resultHourV2('start&end&bookingstart', bookingStartHour, this.selectedStartTime);
                        return;
                    }
                    // Nếu trùng ngày bắt đầu booking và trùng với giờ kết thúc
                    else if (bookingEndDateString === formattedNowDateString && formattedStartDateString) {
                        console.log('3');
                        isBooked = true;
                        this.resultHourV2('start&end&bookingend', bookingEndHour, this.selectedStartTime);
                        return;
                    }
                    // Nếu trùng ngày bắt đầu booking
                    else if (bookingStartDateString === formattedNowDateString) {
                        console.log('4');
                        isBooked = true;
                        this.resultHourV2('start', bookingStartHour, 0);
                        return;
                    }
                    // Nếu trùng ngày kết thúc booking
                    else if (bookingEndDateString === formattedNowDateString) {
                        console.log('5');
                        isBooked = true;
                        this.resultHourV2('end', bookingEndHour, 0);
                        return;
                    }

                    else if (formattedNowDateString === formattedStartDateString && bookingEndDateString !== formattedNowDateString && bookingStartDateString !== formattedNowDateString) {
                        console.log('6', "giờ bắt đầu: ", this.selectedStartTime);
                        isBooked = true;
                        this.resultHourV2('start&end', 0, this.selectedStartTime);
                        return;
                    }
                    // Nếu nằm giữa khoảng booking
                    else if (formattedNow > bookingStartDate && formattedNow < bookingEndDate) {
                        console.log('7');
                        isBooked = true;
                        this.resultHourV2('middle', 0, 0); // Khóa tất cả các giờ
                        return;
                    }
                });

                if (!isBooked) {
                    // Nếu là ngày trống, mở tất cả các giờ
                    this.resultHourV2('free', 0);
                }
            }
        },


        resultHour(type, hour) {
            switch (type) {
                case 'today':
                    // Nếu là ngày bắt đầu booking, mở các giờ từ 0h đến giờ bắt đầu booking
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = p.value < hour + 2; // Khóa các giờ từ giờ bắt đầu trở đi
                    });
                    break;
                case 'start':
                    // Nếu là ngày bắt đầu booking, mở các giờ từ 0h đến giờ bắt đầu booking
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = p.value >= 12; // Khóa các giờ từ giờ bắt đầu trở đi
                    });
                    break;

                case 'end':
                    // Nếu là ngày kết thúc booking, mở các giờ sau giờ kết thúc booking
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = p.value <= 12; // Khóa các giờ từ 0h đến giờ kết thúc
                    });
                    break;

                case 'middle':
                    // Nếu nằm giữa khoảng booking, khóa tất cả các giờ
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = true;
                    });
                    break;

                case 'free':
                    // Nếu là ngày trống, mở tất cả các giờ
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = false;
                    });
                    break;
            }
        },
        resultHourV2(type, hour, hs) {
            const start = parseInt(hs);
            switch (type) {
                case 'today&start':
                    // Nếu là ngày bắt đầu booking, mở các giờ từ 0h đến giờ bắt đầu booking
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = p.value < start + 2;  // Khóa các giờ từ giờ bắt đầu trở đi
                    });
                    break;
                case 'start&end':
                    console.log(hour, ":", start);
                    // Nếu ngày bắt đầu = ngày kết thúc, khóa các giờ từ 0h đến giờ bắt đầu
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = p.value < start + 1;  // Khóa các giờ từ giờ bắt đầu trở đi
                    });
                    break;
                case 'start&end&bookingstart':
                    // Nếu ngày bắt đầu = ngày kết thúc và trùng với giờ bắt đầu, khóa các giờ từ 0h đến giờ bắt đầu
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = (p.value < start + 1) || (p.value >= 12);
                        //p.disabled = p.value < start + 2;   // Khóa các giờ từ giờ bắt đầu trở đi
                    });
                    break;
                case 'start&end&bookingend':
                    // Nếu ngày bắt đầu = ngày kết thúc và trùng với giờ kết thúc, khóa các giờ từ 0h đến giờ kết thúc
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = (p.value < start + 1) || (p.value <= 12);
                        // p.disabled = p.value < start + 2;  // Khóa các giờ từ giờ bắt đầu trở đi
                    });
                    break;
                case 'today':
                    // Nếu là ngày bắt đầu booking, mở các giờ từ 0h đến giờ bắt đầu booking
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = p.value < hour + 2; // Khóa các giờ từ giờ bắt đầu trở đi
                    });
                    break;
                case 'start':
                    // Nếu là ngày bắt đầu booking, mở các giờ từ 0h đến giờ bắt đầu booking
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = p.value >= 12; // Khóa các giờ từ giờ bắt đầu trở đi
                    });
                    break;
                case 'end':
                    // Nếu là ngày kết thúc booking, mở các giờ sau giờ kết thúc booking
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = p.value <= 12; // Khóa các giờ từ 0h đến giờ kết thúc
                    });
                    break;
                case 'middle':
                    // Nếu nằm giữa khoảng booking, khóa tất cả các giờ
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = true;
                    });
                    break;
                case 'free':
                    // Nếu là ngày trống, mở tất cả các giờ
                    Object.values(this.availableHours).forEach(p => {
                        p.disabled = false;
                    });
                    break;
            }
        },

        hasBookedDatesInRange(startDate, endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);

            // Kiểm tra xem start và end có cùng ngày không (bỏ qua giờ)
            const isSameDay = (date1, date2) => {
                return date1.getFullYear() === date2.getFullYear() &&
                    date1.getMonth() === date2.getMonth() &&
                    date1.getDate() === date2.getDate();
            };

            // Biến để kiểm tra xem có booking nào trùng không
            let hasOverlap = false;

            for (const { startLimit, endLimit } of Object.values(this.booking)) {
                const bookingStart = new Date(startLimit);
                const bookingEnd = new Date(endLimit);
                const startHour = bookingStart.getHours();
                const endHour = bookingEnd.getHours();

                console.log("Start Hour:", startHour, "End Hour:", endHour);

                // Kiểm tra nếu ngày bắt đầu và kết thúc nằm trong khoảng booking
                if (
                    (start <= bookingEnd && start >= bookingStart) ||
                    (end <= bookingEnd && end >= bookingStart) ||
                    (start <= bookingStart && end >= bookingEnd)
                ) {
                    hasOverlap = true; // Đánh dấu là có trùng

                    // Trường hợp 1: Start và End cùng ngày
                    if (isSameDay(start, end)) {
                        if (isSameDay(start, bookingStart)) {
                            // Nếu trùng ngày bắt đầu của booking
                            return startHour < 12; // false nếu startHour > 12
                        }
                        if (isSameDay(start, bookingEnd)) {
                            // Nếu trùng ngày kết thúc của booking
                            return endHour > 12; // false nếu endHour < 12
                        }
                        return true;
                    }

                    // Trường hợp 2: Ngày bắt đầu trùng với ngày kết thúc của booking
                    if (isSameDay(start, bookingEnd)) {
                        if (endHour < 12) {
                            console.log("B2: Ngày bắt đầu trùng ngày kết thúc booking, giờ kết thúc < 12");
                            return false;
                        }
                    }

                    // Trường hợp 3: Ngày kết thúc trùng với ngày bắt đầu của booking
                    if (isSameDay(end, bookingStart)) {
                        if (startHour > 12) {
                            console.log("B3: Ngày kết thúc trùng ngày bắt đầu booking, giờ bắt đầu > 12");
                            return false;
                        }
                    }
                }
            }

            // Nếu không có booking nào trùng thì return false
            if (!hasOverlap) {
                console.log("Không có booking nào trùng");
                return false;
            }

            // Nếu có trùng nhưng không rơi vào các trường hợp đặc biệt thì return true
            return true;
        },

        onDateSelect(cellData) {
            const selectedDate = cellData.format();

            if (this.isFirstClick) {
                // Click đầu tiên
                this.startDate = selectedDate;
                console.log(this.startDate);
                this.endDate = null;
                this.isFirstClick = false;
            } else {
                // Click thứ hai
                const firstDate = new Date(this.startDate);
                const secondDate = new Date(selectedDate);

                if (this.hasBookedDatesInRange(
                    firstDate < secondDate ? firstDate : secondDate,
                    firstDate < secondDate ? secondDate : firstDate
                )) {
                    alert('Không thể chọn khoảng thời gian này vì có ngày đã được đặt. Vui lòng chọn lại.');
                    this.isFirstClick = true;
                    this.startDate = null;
                    this.endDate = null;
                } else {
                    if (firstDate < secondDate) {
                        this.endDate = selectedDate;
                    } else {
                        this.endDate = this.startDate;
                        this.startDate = selectedDate;
                    }
                    this.isFirstClick = true;
                }
            }
            this.hoveredDate = null; // Reset hoveredDate sau mỗi lần click
        },

        // Thêm method xử lý hover
        onCellMouseEnter(cell) {
            if (!this.isFirstClick) {
                this.hoveredDate = cell.date;
            }
        },
        async getHours() {
            console.log(this.id);
            const response = await BookingService.GetBookingDays(this.id);
            console.log("Booking days: ", response);
            if (response.success) {
                for (let i = 0; i < response.data.length; i += 2) {
                    this.booking[(i / 2) + 1] = {
                        startLimit: response.data[i],
                        endLimit: response.data[i + 1]
                        // startLimit: this.convertToCustomFormat(response.data[i]),
                        // endLimit: this.convertToCustomFormat(response.data[i + 1])
                    };
                }
            }
            console.log(this.booking);
        },
        convertToCustomFormat(isoString) {
            let date = new Date(isoString);
            let year = date.getFullYear();
            let month = String(date.getMonth() + 1).padStart(2, '0');
            let day = String(date.getDate()).padStart(2, '0');
            let hours = String(date.getHours()).padStart(2, '0');
            let minutes = String(date.getMinutes()).padStart(2, '0');
            let seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
    },
    created() {
        // Lấy giờ hiện tại
        this.getHours();
        const now = new Date();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        let currentTimeValue1 = 0;
        // Tính toán giá trị gần nhất của giờ hiện tại
        if (hours == 10) {
            currentTimeValue1 = 1;
        }
        if (hours == 11) {
            currentTimeValue1 = 2;
        }
        if (hours == 12) {
            currentTimeValue1 = 3;
        }
        else {
            currentTimeValue1 = hours + 2;
        }

        let currentTimeValue = hours + 1;

        // Tìm chỉ số của thời gian hiện tại trong availableHours
        for (const [index, hour] of Object.entries(this.availableHours)) {
            if (hour.value === currentTimeValue) {
                this.selectedStartTime = parseInt(index);
                // break;
            }
            if (hour.value === currentTimeValue1) {
                this.selectedEndTime = parseInt(index);

                break;
            }
        }
    }
};
</script>
<style>
.toast {
    /* position: fixed; */
    /* top: 20px;
  right: 20px; */
    z-index: 1050;
}

.vuecal__cell:before {
    content: "";
    position: absolute;
    z-index: 0;
    top: 0;
    left: 0;
    right: 0px;
    bottom: 0px;
    border: 1px solid rgba(196, 196, 196, .25);
}


/* Ngày bắt đầu */
.vuecal__cell.start-date {
    background-color: #4CAF50 !important;
    position: relative;
    z-index: 2;
}

.vuecal__cell.start-date .vuecal__cell-content {
    color: white !important;
    font-weight: bold;
}

.vuecal__cell.start-date::after {
    content: 'Bắt đầu';
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: white;
}

/* Ngày kết thúc */
.vuecal__cell.end-date {
    background-color: #F44336 !important;
    position: relative;
    z-index: 2;
}

.vuecal__cell.end-date .vuecal__cell-content {
    color: white !important;
    font-weight: bold;
}

.vuecal__cell.end-date::after {
    content: 'Kết thúc';
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: white;
}

/* Ngày trong khoảng đã chọn */
.vuecal__cell.in-range {
    background-color: #E8F5E9 !important;
    position: relative;
    z-index: 1;
}

.vuecal__cell.in-range::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border: 2px dashed #4CAF50;
    pointer-events: none;
}

/* Hiệu ứng hover khi chọn ngày thứ hai */
.vuecal__cell.hover-range {
    background-color: rgba(76, 175, 80, 0.2) !important;
    transition: background-color 0.2s ease;
}

/* Hiệu ứng cho khoảng không hợp lệ */
.vuecal__cell.invalid-range {
    background-color: rgba(244, 67, 54, 0.1) !important;
    position: relative;
}

.vuecal__cell.invalid-range::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border: 2px dashed #F44336;
    pointer-events: none;
}

/* Ngày bị vô hiệu hóa */
.vuecal__cell--disabled {
    text-decoration: line-through;
    background-color: #f5f5f5 !important;
    color: #bdbdbd !important;
    opacity: 0.7;
}

/* Hiệu ứng hover chung */
.vuecal__cell:not(.vuecal__cell--disabled):hover {
    cursor: pointer;
    transition: all 0.2s ease;
    transform: scale(1.05);
}

/* Animation cho việc chọn ngày */
.vuecal__cell {
    transition: all 0.3s ease;
}

/* Tháng hiện tại */
.vuecal__month-grid {
    background-color: white;
}

/* Header của calendar */
.vuecal__header {
    background-color: #4CAF50 !important;
    color: white !important;
}
</style>








<!-- <div class="hours">
                    <label for="">Nhận xe</label>
                    <select v-model="selectedStartTime" @click="CheckHours()">
                        <option v-for="(hour, index) in availableHours" :key="index" :value="index"
                            :hidden="startDate == null" :disabled="hour.disabled">
                            {{ hour.name }}
                        </option>
                    </select>
                </div>
                <div>
                    <label for="">Trả xe</label>
                    <select v-model="selectedEndTime" @click="CheckHoursV2()" @change="SumTimes()">
                        <option v-for="(hour, index) in availableHours" :key="index" :value="index"
                            :hidden="endDate == null" :disabled="hour.disabled">
                            {{ hour.name }}
                        </option>
                    </select>
                </div> -->


<!-- Display the selected time -->
<!-- <p>Giờ bắt đầu bạn chọn là: {{ availableHours[selectedStartTime]?.name }}</p> -->




<!-- Display the selected time -->
<!-- <p>Giờ kết thúc bạn chọn là: {{ availableHours[selectedEndTime]?.name }}</p> -->
